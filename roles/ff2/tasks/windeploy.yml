tasks:

- name: Check if a service is installed
  win_service:
    name: "{{ svc_name }}"
  register: service_check
  
- include_tasks: winprep.yml
  when: service_check.exists == False
  
- include_tasks: winsvcprep.yml
  when: service_check.exists == True
  
- name: Download nuget apppack
  win_get_url:
    url: "{{ app_url }}"
    dest: "{{ svc_path }}"

- name: Unzip nuget apppack
  win_unzip:
    src: "{{ svc_path }}\\{{ apppack_name }}"
    dest: "{{ svc_path }}"

# not need with win_template #too
- name: Download nuget configpack
  win_get_url:
    url: "{{ config_url }}"
    dest: "{{ temp_config_dir }}"
# too
- name: Unzip nuget configpack
  win_unzip:
    src: "{{ temp_config_dir }}\\{{ configpack_name }}"
    dest: "{{ svc_path }}"

#finish
- name: Create files from Jinja2 templates
  win_template:
    src: "{{ item }}"
    dest: "{{ svc_path }}"
  loop: "{{ templates }}"

#too
- name: Remove temp config dir
  win_file:
    path: "{{ temp_config_dir }}"
    state: absent

- name: Create service
  win_service:
    name: "{{ svc_name }}"
    path: "{{ svc_path }}\\nginx.srv.exe"
    display_name: "{{ svc_display_name }}"
    username: "{{ svc_username }}"
    password: "{{ svc_password }}"
    dependencies: "{{ svc_dependencies }}"
    dependency_action: add
    description: "{{ svc_description }}"

- name: Start service
  win_service:
    name: "{{ svc_name }}"
    state: started
  register: service_output

- name: Remove temp dir
  win_file:
    path: "{{ temp_dir }}"
    state: absent

- name: Send mail notification
  mail:
    host: smtp.gmail.com
    port: 587
    username: username@gmail.com
    password: mysecret
    to: John Smith <john.smith@example.com>
    subject: Ansible-report
    body: System "{{ ansible_hostname }}" has been successfully provisioned.
  delegate_to: localhost
