  tasks:
  
- name: Stop service
  win_service:
    name: {{ srv_name }}
    state: stopped
  register: service_output
  
- name: Kill process
  when: service_output.state != 'stopped'
  win_shell: | 
  $svcpid=(Get-WmiObject -Class Win32_Service | where{$_.Name -eq '{{ srv_name }}'}).ProcessId
  Stop-Process $svcpid -Force
  
- name: Delete service
  win_service:
    name: {{ srv_name }}
    state: absent
  
- name: Find folder in work directory
  win_find:
    paths: {{ srv_path }}
    file_type: directory
  register: get_directories
  
- name: Clean base dir
  win_file:
    path: "{{ item }}"
    state: absent
  loop: {{ get_directories.files.path }}
  loop_control:
    pause: 10
  when: 'logs' not in item
  
  
- name: Download nuget packet
  win_get_url:
    url: {{ some_url }}
    dest: {{ srv_path }}
    
- name: Unzip nuget packet
  win_unzip:
    src: {{ srv_path }}
    dest: C:\ExtractedLogs\application-error-logs

- name: Deploy config
...

- name: Remove temp config dir
  win_file:
    path: {{ temp_config_dir }}
    state: absent

- name: Create service
  win_service:
    name: {{ srv_name }}
    path: {{ srv_path }}
    display_name: {{ srv_display_name }}
    username: {{ srv_username }}
    password: {{ srv_password }}
    dependencies: {{ srv_dependencies }}
    description: {{ srv_description }}

- name: Create directory structure
  win_file:
    path: {{ srv_path }}
    state: directory

- name: Setup permissions
  win_acl:
    path: {{ srv_path }}
    user: {{ srv_username }}
    rights: FullControl, Modify, Read
    type: allow
    state: present
    inherit: ContainerInherit, ObjectInherit

- name: Start service
  win_service:
    name: {{ srv_name }}
    state: started
  register: service_output

- name: Remove temp dir
  win_file:
    path: {{ temp_dir }}
    state: absent

- name: Send mail notification
  mail:
    host: smtp.gmail.com
    port: 587
    username: username@gmail.com
    password: mysecret
    to: John Smith <john.smith@example.com>
    subject: Ansible-report
    body: System {{ ansible_hostname }} has been successfully provisioned.
  delegate_to: localhost
